<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Custom Backbone Integration - Vortex</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/ir-black.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/console.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Vortex</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../user-guides/dataset_integration/" class="dropdown-item">Dataset Integration</a>
</li>
                                    
<li>
    <a href="../../user-guides/experiment_file_config/" class="dropdown-item">Experiment File Configuration</a>
</li>
                                    
<li>
    <a href="../../user-guides/hypopt_file_config/" class="dropdown-item">HypOpt File Configuration</a>
</li>
                                    
<li>
    <a href="../../user-guides/pipelines/" class="dropdown-item">Pipelines</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Developer Guides <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Custom Backbone Integration</a>
</li>
                                    
<li>
    <a href="../custom_model_integration_classification/" class="dropdown-item">Custom Model Integration : Classification</a>
</li>
                                    
<li>
    <a href="../custom_model_integration_detection/" class="dropdown-item">Custom Model Integration : Detection</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../modules/builtin_dataset/" class="dropdown-item">Built-in Dataset</a>
</li>
                                    
<li>
    <a href="../../modules/logging_provider/" class="dropdown-item">Logging Provider</a>
</li>
                                    
<li>
    <a href="../../modules/augmentation/" class="dropdown-item">Augmentations</a>
</li>
                                    
<li>
    <a href="../../modules/data_loader/" class="dropdown-item">Data Loader</a>
</li>
                                    
<li>
    <a href="../../modules/scheduler/" class="dropdown-item">Learning Rates Scheduler</a>
</li>
                                    
<li>
    <a href="../../modules/train_driver/" class="dropdown-item">Training Driver</a>
</li>
                                    
<li>
    <a href="../../modules/models_zoo/" class="dropdown-item">Models Zoo</a>
</li>
                                    
<li>
    <a href="../../modules/backbones/" class="dropdown-item">Backbones Network</a>
</li>
                                    
<li>
    <a href="../../modules/exporter/" class="dropdown-item">Graph Exporter</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">API <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/vortex.development.core.pipelines/" class="dropdown-item">vortex.development.core.pipelines</a>
</li>
                                    
<li>
    <a href="../../api/vortex.development.core.factory/" class="dropdown-item">vortex.development.core.factory</a>
</li>
                                    
<li>
    <a href="../../api/vortex.runtime/" class="dropdown-item">vortex.runtime</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="https://github.com/nodefluxio/vortex" class="nav-link">Repository</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../user-guides/pipelines/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../custom_model_integration_classification/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#implements-custom-backbone-module-in-vortex" class="nav-link">Implements Custom Backbone Module in Vortex</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1-vortex-backbone-module" class="nav-link">1. Vortex Backbone Module</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-registering-builder-function" class="nav-link">2. Registering builder function</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-pretrained-weights-and-module-restructure-hack" class="nav-link">3. Pretrained weights and module restructure hack</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4-integration-with-vortex-cli" class="nav-link">4. Integration with vortex CLI</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="implements-custom-backbone-module-in-vortex">Implements Custom Backbone Module in Vortex<a class="headerlink" href="#implements-custom-backbone-module-in-vortex" title="Permanent link">&para;</a></h1>
<p>This tutorial shows how to develop your own backbone module and integrate it to <code>vortex</code>.
The tutorial consists of 4 steps:</p>
<ol>
<li>Vortex Backbone Module</li>
<li>Registering <em>builder</em> function</li>
<li>Pretrained weights and module restructure <em>hack</em></li>
<li>Integration with <code>vortex</code> CLI</li>
</ol>
<pre><code class="language-python">import torch
import torch.nn as nn
import torchvision as vision

import warnings

import vortex
import vortex.development.networks as networks
import vortex.development.networks.modules as vortex_modules
</code></pre>
<hr />
<h2 id="1-vortex-backbone-module">1. Vortex Backbone Module<a class="headerlink" href="#1-vortex-backbone-module" title="Permanent link">&para;</a></h2>
<p>On computer vision tasks, it is often necessary to perform experiment
on various backbone networks. Hence, it is useful to have adapter
to multiple backbone, if desired.</p>
<p><code>vortex</code> has such <em>adapter</em> capability with its <code>BackbonePoolConnector</code>
that provides interfaces to any registered backbone. The registered 
backbone itself should be type of <code>Backbone</code> class which actually
an adapter for <code>nn.Sequential</code> to also returns its <em>intermediate results</em>.</p>
<hr />
<h2 id="2-registering-builder-function">2. Registering <em>builder</em> function<a class="headerlink" href="#2-registering-builder-function" title="Permanent link">&para;</a></h2>
<p>Registering backbone is done by adding <em>builder</em> function to <code>vortex</code>.
To register the function, we decorate our function with </p>
<pre><code>@vortex.development.networks.modules.backbones.register_backbone(model_name)
def get_backbone(...)
</code></pre>
<p>or we can call <code>register_backbone_</code> directly.</p>
<p>The function <em>should</em> be named <code>get_backbone</code>. When calling decorator,
we can register multiple model on single function. And the function signature:</p>
<pre><code>get_backbone(model_name, pretrained, feature_type, **kwargs) -&gt; Backbone
</code></pre>
<p>where <code>model_name</code> is <code>str</code> representing the identifier of requested backbone model, 
<code>pretrained</code> may be <code>str</code> or path-like depending on the caller, 
and <code>feature_type</code> is <code>str</code> for customization point if necessary.</p>
<p>In this case we will add <code>SqueezeNet</code> as backbone to <code>vortex</code>. For the sake
of simplicity, we'll load existing network &amp; pretrained from <code>torchvision</code>.</p>
<pre><code class="language-python">register_backbone = vortex_modules.backbones.register_backbone

@register_backbone(['squeezenetv1.1', 'squeezenetv1.0'])
def get_backbone(model_name, pretrained=False, feature_type='tri_stage_fpn', n_classes=1000, **kwargs):
    &quot;&quot;&quot;
    create squeezenet (v1.0 &amp; v1.1) backbone
    &quot;&quot;&quot;
</code></pre>
<hr />
<h2 id="3-pretrained-weights-and-module-restructure-hack">3. Pretrained weights and module restructure <em>hack</em><a class="headerlink" href="#3-pretrained-weights-and-module-restructure-hack" title="Permanent link">&para;</a></h2>
<p>In many cases, we do not want to develop from scratch but use existing
module instead. But, this raises an issue since not all existing module
are the same structure and dynamic nature of pytorch scripts make us
difficult to reuse module and pretrained weights.</p>
<p>To be able to reuse pretrained weights, we could first load the original
structure of the network and then load the <code>state_dict</code> and then
restructure filter parts of the network to <code>nn.Sequential</code> 
(as required by <code>Backbone</code>). We do this <em>hack</em> on our <em>builder</em> function.</p>
<p>Since we know that available pretrained model is trained on ImageNet, and
we want to use pretrained weights, let's set the initial number of classes 
to 1000 before loading the model.</p>
<pre><code class="language-python">    # we use `n_classes` but torch vision uses `num_classes`
    kwargs.update({'num_classes': n_classes})
    num_classes = kwargs.get('num_classes', 1000)
    if pretrained and num_classes != 1000:
        warnings.warn('temporarily change number of classes to get imagenet pretrained weights')
        kwargs.update({'num_classes': 1000})

    if model_name == 'squeezenetv1.1':
        model = vision.models.squeezenet1_1(pretrained=pretrained, **kwargs)
    elif model_name == 'squeezenetv1.0':
        model = vision.models.squeezenet1_0(pretrained=pretrained, **kwargs)
    else:
        raise RuntimeError(&quot;model f{model_name} not supported&quot;)
</code></pre>
<p>After the model initialization, the next step is to prepare feature extractor.
We can use <code>feature_type</code> as customization point if specific feature
extractor are required, for example, you want to return feature from
activation input instead of activation output, etc. Current 
implementation needs <code>'tri_stage_fpn'</code> and <code>'classifier'</code> 
to be defined. For <code>'tri_stage_fpn'</code> we need to split
the <code>feature</code> to five stages. For <code>'classifier'</code>, we need to
provide both <code>feature</code> and <code>classifier</code>.</p>
<pre><code class="language-python">    if feature_type == 'tri_stage_fpn':
        if model_name == 'squeezenetv1.1':
            features = [
                model.features[0],
                model.features[1:3],
                model.features[3:7],
                model.features[7:12],
                model.features[12:],
            ]
        elif model_name == 'squeezenetv1.0':
            features = [
                model.features[0],
                model.features[1:3],
                model.features[3:6],
                model.features[6:8],
                model.features[8:],
            ]
        features = vortex_modules.Backbone(nn.Sequential(*features))
</code></pre>
<p>For <code>'classifier'</code> feature, we may need to restore original number of
classes if we were loading from pretrained model.</p>
<pre><code class="language-python">    elif feature_type == 'classifier':
        # looking at squeezenet implementation, we need to reset this layer
        # also note that we need to add nn.Flatten()
        if pretrained and num_classes != 1000:
            model.classifier[1] = nn.Conv2d(512, num_classes, kernel_size=1)
        classifier_feature = nn.Sequential(
            model.classifier, nn.Flatten()
        )
        features = model.features
        features = vortex_modules.ClassifierFeature(
            features,classifier=classifier_feature
        )
</code></pre>
<p>Raise error here if given <code>feature_type</code> is not supported.</p>
<pre><code class="language-python">    else:
        raise RuntimeError(&quot;feature type f{feature_tyep} not supported by f{model_name}&quot;)

    ret = dict(
        features=features
    )
    if feature_type == 'classifier':
        ret.update(dict(
            classifier=classifier_feature
        ))

    return features

</code></pre>
<hr />
<h2 id="4-integration-with-vortex-cli">4. Integration with vortex CLI<a class="headerlink" href="#4-integration-with-vortex-cli" title="Permanent link">&para;</a></h2>
<p>Finally, we make this module as entry-point for our next experiments
to get more vortex' features in a <em>configurable</em> way:  </p>
<ul>
<li>hyperparameter optimization  </li>
<li>training  </li>
<li>validation  </li>
<li>TorchScript &amp; ONNX export (with batch inference support)   </li>
<li>TensorRT inference (using ONNX model)  </li>
</ul>
<pre><code class="language-python">if __name__=='__main__':
    ## let's use vortex_cli to demonstrate vortex features
    ## this will be our entrypoint to supported experiments
    vortex.development.vortex_cli.main()
</code></pre>
<p>Note that since our custom model is added outside the vortex distribution,
it is unavailable from <code>vortex</code> command-line, to properly run experiments
with our custom model registered we need to invoke python, for example</p>
<pre><code class="language-Shell">python3 squeezenet.py train --config cifar10.yml
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
